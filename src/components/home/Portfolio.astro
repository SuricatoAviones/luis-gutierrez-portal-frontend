---
// src/components/sections/Portfolio.astro
import { getProjects, parseTechs } from '../../lib/wordpress';
import type { Project } from '../../lib/wordpress';

const fallbackProjects: Project[] = [
  {
    id: 1,
    title: { rendered: 'E-commerce Platform' },
    acf: {
      project_url: '#',
      github_url: '#',
      description: 'Plataforma de comercio electrónico completa con carrito, pagos y panel de administración.',
      technologies: 'Next.js, TypeScript, Stripe, PostgreSQL',
      featured_image: '',
      year: '2024',
      category: 'Full Stack',
    },
  },
  {
    id: 2,
    title: { rendered: 'Dashboard de Analíticas' },
    acf: {
      project_url: '#',
      github_url: '#',
      description: 'Dashboard interactivo con métricas en tiempo real y visualizaciones de datos avanzadas.',
      technologies: 'React, D3.js, Node.js, WebSockets',
      featured_image: '',
      year: '2024',
      category: 'Frontend',
    },
  },
  {
    id: 3,
    title: { rendered: 'API REST para Fintech' },
    acf: {
      project_url: '#',
      github_url: '#',
      description: 'API robusta para gestión de transacciones financieras con autenticación JWT y roles.',
      technologies: 'Node.js, Express, MySQL, Redis',
      featured_image: '',
      year: '2023',
      category: 'Backend',
    },
  },
  {
    id: 4,
    title: { rendered: 'Blog Headless CMS' },
    acf: {
      project_url: '#',
      github_url: '#',
      description: 'Blog estático ultra-rápido con WordPress como CMS headless y Astro como frontend.',
      technologies: 'Astro, WordPress API, ACF, Tailwind',
      featured_image: '',
      year: '2023',
      category: 'Full Stack',
    },
  },
];

let projects = fallbackProjects;

try {
  const fetched = await getProjects();
  if (fetched.length > 0) projects = fetched;
} catch {
  // Usa fallback
}
---

<section id="portafolio" class="py-24 lg:py-32">
  <div class="max-w-content mx-auto px-6 lg:px-10">

    <!-- Encabezado de sección -->
    <div class="flex items-center justify-between mb-16 reveal">
      <div class="flex items-center gap-4">
        <span class="font-mono text-2xs text-accent uppercase tracking-widest">03</span>
        <span class="block w-8 h-px bg-accent"></span>
        <h2 class="font-display text-3xl lg:text-4xl font-semibold text-ink">Portafolio</h2>
      </div>
      <a
        href="/portafolio"
        class="hidden sm:inline-flex items-center gap-2 text-sm text-muted hover:text-ink transition-colors"
      >
        Ver todos
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>

    <!-- Grid de proyectos -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {projects.map((project, i) => {
        const techs = parseTechs(project.acf.technologies);
        const delay = (i % 2) * 100;

        return (
          <article
            class="reveal group relative flex flex-col bg-parchment border border-border rounded-2xl overflow-hidden hover:border-accent/40 transition-all duration-300 hover:shadow-lg hover:-translate-y-1"
            style={`animation-delay: ${delay}ms`}
          >
            <!-- Imagen / Placeholder -->
            <div class="relative w-full aspect-video bg-accent-light overflow-hidden">
              {project.acf.featured_image ? (
                <img
                  src={project.acf.featured_image}
                  alt={project.title.rendered}
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                />
              ) : (
                <div class="w-full h-full flex items-center justify-center">
                  <span class="font-display text-5xl font-bold text-accent/20">
                    {project.title.rendered.charAt(0)}
                  </span>
                </div>
              )}
              <!-- Badge categoría -->
              <span class="absolute top-4 left-4 font-mono text-2xs uppercase tracking-wider bg-parchment/90 text-ink px-3 py-1 rounded-full backdrop-blur-sm">
                {project.acf.category}
              </span>
              <!-- Badge año -->
              <span class="absolute top-4 right-4 font-mono text-2xs uppercase tracking-wider bg-parchment/90 text-muted px-3 py-1 rounded-full backdrop-blur-sm">
                {project.acf.year}
              </span>
            </div>

            <!-- Contenido -->
            <div class="flex flex-col flex-1 p-6">
              <h3 class="font-display text-xl font-semibold text-ink mb-2 group-hover:text-accent transition-colors">
                {project.title.rendered}
              </h3>
              <p class="text-sm text-muted leading-relaxed flex-1 mb-5">
                {project.acf.description}
              </p>

              <!-- Stack de tecnologías -->
              <div class="flex flex-wrap gap-2 mb-5">
                {techs.map((tech) => (
                  <span class="font-mono text-2xs text-muted bg-border/60 px-2.5 py-1 rounded-full">
                    {tech}
                  </span>
                ))}
              </div>

              <!-- Links -->
              <div class="flex items-center gap-4 pt-4 border-t border-border">
                {project.acf.project_url && project.acf.project_url !== '#' && (
                  <a
                    href={project.acf.project_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-1.5 text-sm font-medium text-ink hover:text-accent transition-colors"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                    </svg>
                    Demo en vivo
                  </a>
                )}
                {project.acf.github_url && project.acf.github_url !== '#' && (
                  <a
                    href={project.acf.github_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-1.5 text-sm text-muted hover:text-ink transition-colors"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.44 9.8 8.21 11.38.6.11.82-.26.82-.58v-2.03c-3.34.73-4.04-1.61-4.04-1.61-.55-1.39-1.33-1.76-1.33-1.76-1.09-.74.08-.73.08-.73 1.2.09 1.84 1.24 1.84 1.24 1.07 1.83 2.81 1.3 3.5 1 .11-.78.42-1.3.76-1.6-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.13-.3-.54-1.52.12-3.18 0 0 1.01-.32 3.3 1.23a11.5 11.5 0 013-.4c1.02.01 2.04.14 3 .4 2.28-1.55 3.29-1.23 3.29-1.23.66 1.66.25 2.88.12 3.18.77.84 1.24 1.91 1.24 3.22 0 4.61-2.81 5.63-5.48 5.92.43.37.81 1.1.81 2.22v3.29c0 .32.22.7.83.58C20.57 21.8 24 17.3 24 12c0-6.63-5.37-12-12-12z" />
                    </svg>
                    GitHub
                  </a>
                )}
              </div>
            </div>
          </article>
        );
      })}
    </div>

    <!-- Ver todos mobile -->
    <div class="mt-10 text-center sm:hidden reveal">
      <a href="/portafolio" class="inline-flex items-center gap-2 text-sm text-muted hover:text-ink transition-colors">
        Ver todos los proyectos →
      </a>
    </div>

  </div>
</section>